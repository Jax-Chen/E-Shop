define([],function(){var a=function(a,b){this.origin=a,this.path=b,this._iframe=null,this._iframeReady=!1,this._queue=[],this._requests={},this._id=0};return a.prototype={op:{WRITE:"W",READ:"R",DEL:"D",CLEAR:"X"},constructor:a,init:function(){var a=this;if(!this._iframe){if(!(window.postMessage&&window.JSON&&window.localStorage))throw new Error("Unsupported browser.");this._iframe=document.createElement("iframe"),this._iframe.style.cssText="position:absolute;width:1px;height:1px;left:-9999px;",document.body.appendChild(this._iframe),window.addEventListener?(this._iframe.addEventListener("load",function(){a._iframeLoaded()},!1),window.addEventListener("message",function(b){a._handleMessage(b)},!1)):this._iframe.attachEvent&&(this._iframe.attachEvent("onload",function(){a._iframeLoaded()},!1),window.attachEvent("onmessage",function(b){a._handleMessage(b)}))}this._iframe.src=this.origin+this.path},getValue:function(a,b){this._toSend({key:a},b)},setValue:function(a,b,c){this._toSend({key:a,op:this.op.WRITE,value:b},c)},delValue:function(a,b){this._toSend({key:a,op:this.op.DEL,value:value},b)},clearValue:function(a){this._toSend({op:this.op.CLEAR},a)},_toSend:function(a,b){var c={request:{key:a.key,id:++this._id,op:a.op,value:a.value},callback:b};this._iframeReady?this._sendRequest(c):this._queue.push(c),this._iframe||this.init()},_sendRequest:function(a){this._requests[a.request.id]=a,this._iframe.contentWindow.postMessage(JSON.stringify(a.request),this.origin)},_iframeLoaded:function(){if(this._iframeReady=!0,this._queue.length){for(var a=0,b=this._queue.length;b>a;a++)this._sendRequest(this._queue[a]);this._queue=[]}},_handleMessage:function(a){if(a.origin==this.origin){var b=JSON.parse(a.data);this._requests[b.id]&&this._requests[b.id].callback&&this._requests[b.id].callback(b.key,b.value),delete this._requests[b.id]}}},a});