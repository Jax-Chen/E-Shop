/*! trade */
define(["jquery","Keeper","base64","passport","dialogReg"],function(a,b,c,d){function e(b){var c=a(".send_reg_captchado");c.removeAttr("disabled"),c.val(c.attr("data-text-ready")),b&&(b.clickable=!0),window.sms_has_timer=0,clearInterval(window.sms_timer)}function f(b){var c=a(".voice-code-wrapper a"),d=a(".send_reg_captchado"),f=Keeper("regDialog");if(window.sms_has_timer){var g=60-Math.floor((Date.now()-window.sms_has_timer)/1e3);g=0>g?0:g}else g=60,window.sms_has_timer=Date.now();g?(clearInterval(window.sms_timer),window.sms_timer=setInterval(function(){g-=1,g>0?(d.val("重发验证("+g+")").css({color:"#ccc",cursor:"default"}),c.css({color:"#ccc",cursor:"default","text-decoration":"none"}).addClass("voice_disable")):(c.css({color:"#666",cursor:"pointer","text-decoration":"underline"}).removeClass("voice_disable"),d.css({color:"#666",cursor:"pointer"}),a(".error_msg").hide(),f.voice_code_tip(a("#voicemsg")),clearInterval(window.sms_timer),e(b))},1e3)):e(b)}function g(a){a=a||"";var b=new Image;b.src="http://analysis.tuanimg.com/click_v0.gif?clickkey="+a+"&hiveid=20873400391445594650&date="+Date.now()}b("dialogPP",{customeDataCache:{flag:!1,cache:"",isCart:!1,isImmidately:!1},ppTpl:function(c,e,h){var i=h.t||this,j=h.appid,k=PassportCardList[c];k.captcha_check=!0,k.rootElement=function(){this.cElement=e,this.sElement=e.after('<div class="hidden"></div>').next()},k._drawLoginForm=function(){var e="?return_to="+encodeURIComponent("http://shop.zhe800.com/n/crossdomain"),h=!0,l=new b.Buffers;if(l.push('<form onsubmit="return PassportCardList['+c+'].doLogin();" name="loginform">'),l.push('<input type="hidden" value="'+j+'" name="login_appid">'),l.push('<input type="hidden" class="sms_dynamic_login" name="sms_dynamic_login" value="false" />'),window.login_with_mobile){l.push(' <h3 class="hwid2"> <input type="radio" name="loginppr" class="zhe-account" value="0"/> 折800账号登录 <input type="radio" name="loginppr" class="phonecode" checked="checked" value="1"/> <span class="phonecode">手机动态码登录</span>');try{"miao.zhe800.com"==window.location.host?l.push('     <a class="reglink" target="_blank" href="https://passport.zhe800.com/users/signup">立即注册</a>'):l.push('     <a class="reglink" target="_blank" href="javascript: void(0)">立即注册</a>')}catch(m){}l.push(" </h3>")}else{l.push(' <h3 class="hwid2"> <input type="radio" name="loginppr" class="zhe-account" checked="checked" value="0"/> 折800账号登录 <input type="radio" class="phonecode" name="loginppr" value="1"/> <span class="phonecode">手机动态码登录</span>');try{"miao.zhe800.com"==window.location.host?l.push('     <a class="reglink" target="_blank" href="https://passport.zhe800.com/users/signup">立即注册</a>'):l.push('     <a class="reglink" target="_blank" href="javascript: void(0)">立即注册</a>')}catch(m){}l.push(" </h3>")}l.push('<input type="hidden" id="reg_authenticity_token" value="">'),l.push('<input type="hidden" id="voice_step" value="1">'),l.push('<input type="hidden" id="voice_token" value="">'),l.push('<input type="hidden" id="voice_csrf" value="">'),l.push(" <ul>"),window.login_with_mobile?(l.push('     <li class="username-and-password valueone valuetwo">'),l.push('         <input value="请输入注册手机号" title="请输入注册手机号" data-account-placeholder="邮箱/手机号/用户名" data-mobile-placeholder="请输入注册手机号" onfocus="this.value==this.title?this.value=\'\':null" onblur="this.value==\'\'?this.value=this.title:null" id="ddusername" name="username" type="text" autocomplete="off" disableautocomplete="" />'),l.push("     </li>"),l.push('     <li id="phone_img_captcha_box" class="captcha_box_new token" data-allow-captcha="no">'),l.push('         <input type="hidden" name="captcha_keywords" value="" />'),l.push('         <input type="text" name="captcha_img" value="" title="验证码" onfocus="this.value==this.title?this.value=\'\':null" onblur="this.value==\'\'?this.value=this.title:null" autocomplete="off" disableautocomplete="" /><img class="captcha-img captchaImg" src=""/>'),l.push('         <a href="javascript:void(0)" class="captRefash">换一张</a>'),l.push("     </li>"),l.push('     <li class="username-and-password valueone dtcode valuetwo">'),l.push('         <input style="display:none" value="" name="password" id="ddpw_1" class="ddpw_1_cls gphcode" type="text" data-allow-input="0" autocomplete="off" disableautocomplete="" /><input value="获取动态码" data-account-placeholder="请输入密码" data-mobile-placeholder="动态密码" class="ddpw_1_text_cls gphcode" id="ddpw_1_text" type="text" autocomplete="off" disableautocomplete="" /><input type="button" class="getdphcode getdphcode-btn send_reg_captchado" value="获取动态密码" data-text-ready="获取动态码" data-text-submit="提交中..."/>'),l.push("     </li>")):(l.push('     <li class="username-and-password valueone">'),l.push('         <input value="邮箱/手机号/用户名" title="邮箱/手机号/用户名" data-account-placeholder="邮箱/手机号/用户名" data-mobile-placeholder="请输入注册手机号" onfocus="this.value==this.title?this.value=\'\':null" onblur="this.value==\'\'?this.value=this.title:null" id="ddusername" name="username" type="text" autocomplete="off" disableautocomplete="" />'),l.push("     </li>"),l.push('     <li id="phone_img_captcha_box" style="display:none;" class="captcha_box_new token" data-allow-captcha="no">'),l.push('         <input type="hidden" name="captcha_keywords" value="" />'),l.push('         <input type="text" name="captcha_img" value="" title="验证码" onfocus="this.value==this.title?this.value=\'\':null" onblur="this.value==\'\'?this.value=this.title:null" autocomplete="off" disableautocomplete="" /><img class="captcha-img captchaImg" src=""/>'),l.push('         <a href="javascript:void(0)" class="captRefash">换一张</a>'),l.push("     </li>"),l.push('     <li class="username-and-password valueone dtcode">'),l.push('         <input style="display:none" value="" name="password" id="ddpw_1" class="ddpw_1_cls gphcode" type="password" data-allow-input="0" autocomplete="off" disableautocomplete="" /><input value="请输入密码" data-account-placeholder="请输入密码" data-mobile-placeholder="动态密码" class="ddpw_1_text_cls gphcode" id="ddpw_1_text" type="text" autocomplete="off" disableautocomplete="" /><input type="button" class="getdphcode getdphcode-btn send_reg_captchado" value="获取动态密码" data-text-ready="获取动态码" data-text-submit="提交中..."/>'),l.push("     </li>"));var n=" hidden",o="";!window.login_with_mobile&&window.login_need_captcha&&(n=""),l.push('     <li class="captcha_box token'+n+'">'),l.push('         <input type="text" value="" title="验证码" onfocus="this.value==this.title?this.value=\'\':null" onblur="this.value==\'\'?this.value=this.title:null" id="ddcaptcha" name="captcha" autocomplete="off" disableautocomplete="" /><img class="captchaImg"'+o+" />"),l.push('         <a href="javascript:void(0)" class="captRefash">换一张</a>'),l.push("     </li>"),l.push('     <li class="btn">'),l.push('         <input type="submit" class="sign statisticalObject" value="立即登录" onfocus="this.blur()" alt="登 录" title="登 录"/>'),l.push("     </li>"),l.push('     <li class="ologintip">'),l.push('         <div class="error pperrmsg error_msg hidden" id="pperrmsg"></div>'),l.push('         <div class="voicemsg" id="voicemsg"></div>'),l.push("         <span>使用其他账号登录</span>"),l.push("         <i></i>"),l.push("     </li>"),l.push(" </ul>"),l.push("</form>"),l.push('<div class="sf clear">'),l.push('<div class="sf_content"><p><a data-behavior="third-party-login" class="qq statisticalObject" href="https://passport.tuan800.com/sso/partner_login/qq_connect'+e+"&appid="+j+'"><i></i><span>QQ登录</span></a>'),l.push('<a class="morela"><span>更多&gt;&gt;</span></a></p>'),l.push('<p class="more_logina hidden">'),l.push('<a data-behavior="third-party-login" class="baidu statisticalObject" href="https://passport.tuan800.com/sso/partner_login/baidu'+e+"&appid="+j+'"></a>'),l.push('<a data-behavior="third-party-login" class="sina statisticalObject" href="https://passport.tuan800.com/sso/partner_login/weibo'+e+"&appid="+j+'"></a>'),l.push('<a data-behavior="third-party-login" class="taobao statisticalObject" href="https://passport.tuan800.com/sso/partner_login/taobao?return_to='+e+"&appid="+j+'"></a>'),l.push('<a data-behavior="third-party-login" class="renren statisticalObject" href="https://passport.tuan800.com/sso/partner_login/renren'+e+"&appid="+j+'"></a>'),l.push("</p></div>"),l.push("</div>"),this.cElement.html(l.toString());var p=a(this.cElement),q=p.find('form[name="loginform"]  .send_reg_captchado'),r=p.find('form[name="loginform"] input[name="username"]'),s=p.find('form[name="loginform"] .ddpw_1_text_cls'),t=p.find('form[name="loginform"] .ddpw_1_cls'),u={account:{username:r.attr("data-account-placeholder"),password:s.attr("data-account-placeholder"),type:"password"},mobile:{username:r.attr("data-mobile-placeholder"),password:s.attr("data-mobile-placeholder"),type:"text"}};p.find('form[name="loginform"] input:radio').on("change",function(){"0"===a(this).val()?(window.login_with_mobile=!1,a("#pperrmsg").removeClass("mobile_msg"),p.find("li.username-and-password").removeClass("valuetwo"),p.find(".sms_dynamic_login").val("false"),r.val(u.account.username).attr("title",u.account.username),s.val(u.account.password),t.val("")[0].type=u.account.type,t.trigger("blur"),g("zhanghaodenglu_tanchuang"),window.login_need_captcha&&(p.find(".captcha_box").show(),p.find(".captcha_box_new").hide()),p.find('form[name="loginform"] input[name="loginppr"].zhe-account').each(function(a,b){b.checked=!0}),d.getCaptcha(function(a){p.find(".captcha_box .captchaImg").attr("src",login_error_result.captcha_img)}),a("#voicemsg").hide()):(window.login_with_mobile=!0,a("#pperrmsg").addClass("mobile_msg"),p.find("li.username-and-password").addClass("valuetwo"),p.find(".sms_dynamic_login").val("true"),a(".sms_dynamic_login").val()&&a(".valuetwo input#ddusername").focus(function(){"请输入注册手机号"==a(this).val()&&a(this).val("")}).blur(function(){""==a(this).val()?(a(".mobile_msg").html("<em></em>请输入手机号").css("display","block"),a(this).val("请输入注册手机号")):/^1\d{10}$/.test(a(this).val())?a("#pperrmsg").hide():a(".mobile_msg").html("<em></em>手机号格式错误").css("display","block")}),window.login_need_captcha&&(p.find(".captcha_box").hide(),i.getCaptcha(),p.find(".captcha_box_new").show()),r.val(u.mobile.username).attr("title",u.mobile.username),s.val(u.mobile.password),t.val("")[0].type=u.mobile.type,t.trigger("blur"),g("dongtaimadenglu_tanchuang"),p.find('form[name="loginform"] input[name="loginppr"].phonecode').each(function(a,b){b.checked=!0}),a("#voicemsg").show()),p.find('form[name="loginform"] .pperrmsg').text(""),a(".error_msg").hide()}),setTimeout(function(){i.sendCaptchado(q,"login",r)},0),!window.login_with_mobile&&window.login_need_captcha?(d.getCaptcha(function(a){p.find(".captcha_box .captchaImg").attr("src",login_error_result.captcha_img)}),a(".captcha_box .captRefash").on("click",function(b){b.preventDefault(),d.getCaptcha(function(b){a(".captcha_box .captchaImg").attr("src",login_error_result.captcha_img)})}),k.login_expms=""):window.login_with_mobile&&(d.getCaptcha(function(a){p.find(".captcha_box_new .captchaImg").attr("src",login_error_result.captcha_img)}),a(".captcha_box_new .captRefash").on("click",function(b){b.preventDefault(),d.getCaptcha(function(b){a(".captcha_box_new .captchaImg").attr("src",login_error_result.captcha_img)})}),k.login_expms=""),window.login_with_mobile&&window.sms_has_timer&&(q.attr("disabled","disabled"),k.clickable&&(k.clickable=!1),f(k)),p.find('form[name="loginform"]').on("click",'[data-behavior="voice-code"]',function(b){b.preventDefault();var c=a(this).parents('form[name="loginform"]'),d=c.find("#ddusername"),e=c.find(".pperrmsg"),f=c.find(".voicemsg"),h=c.find("#phone_img_captcha_box"),i=h.find('input[name="captcha_img"]'),j=c.find("#voice_step").val(),l=c.find("#voice_token").val(),m=c.find("#voice_csrf").val(),n=Keeper("regDialog");if(!a(".voice-code-wrapper a").hasClass("voice_disable")){if(a(".error_msg").hide(),g("yuyin_logintanchuang"),d.val()===d.attr("title")||""===d.val())return e.html("<em></em>请输入手机号").show(),!1;if(!/^1\d{10}/.test(d.val()))return e.html("<em></em>手机号格式有误").show(),!1;if(""===m&&(m=(+new Date+""+d.val()).substring(0,16),c.find("#voice_csrf").val(m)),k.login_expms="&"+a.param({business_code:m,validate_token:l,step:2}),"1"===j)""===l?n.voiceToken({$form:c,$mobile:d,$imgCpatcha:h,$pperrmsg:f,step:1,business_code:m}):n.voiceCode({$form:c,$mobile:d,$imgCpatchaIpt:i,$pperrmsg:f,step:1,validate_token:l,business_code:m});else{var i=h.find('input[name="captcha_img"]');if("yes"===h.attr("data-allow-captcha")&&""===i.val()||i.val()===i.attr("title"))return a(".error_msg").show(),n.voice_code_tip(f,2),!1;n.voiceCode(c,d,i,f)}}}),a('form[name="loginform"]').on("focus",".ddpw_1_text_cls",function(){a(".ddpw_1_text_cls").hide(),a(".ddpw_1_cls").show().focus()}),a('form[name="loginform"]').on("focus",".ddpw_1_cls",function(){a(this).attr("data-allow-input","1")}).on("blur",".ddpw_1_cls",function(){a(this).attr("data-allow-input","0"),""==a(this).val()&&(a(".ddpw_1_text_cls").show(),a(".ddpw_1_cls").hide())}),a('form[name="loginform"]').on("input",".ddpw_1_cls",function(){var b=a(this);window.login_with_mobile&&"0"===b.attr("data-allow-input")&&b.val("")}),a(".morela").toggle(function(){a(this).find("span").html("收起&lt;&lt;"),a(".more_logina").removeClass("hidden")},function(){a(this).find("span").html("更多&gt;&gt;"),a(".more_logina").addClass("hidden")});var v=0;try{"miao.zhe800.com"!=window.location.host&&a(".reglink").click(function(b){var d,e=Keeper("regDialog"),f=a(this).parents("form").parent(),g=f.find('input[name="login_appid"]').val();window.login_with_mobile=!1,v++,a("#dialog_log_qiandao .close").trigger("click"),d="ppLogin_qd"===f.attr("id")?"qd":"login-panel"===f.attr("id")?"log":"qd",i.customeDataCache.flag=!0,i.customeDataCache.isImmidately=!1,e.renderForm(d,g,c),i.statisticCount("立即注册"),a(".close").click(function(a){i.customeDataCache.isImmidately===!1&&i.statisticCount("注册后关闭"),v=0,i.customeDataCache.flag=!1}),i.getClickObj(),b.preventDefault()})}catch(m){}a(".close").click(function(a){0===v&&i.statisticCount("关闭操作"),v=0,window.login_with_mobile=!1}),a("#dialog_log_qiandao").delegate(".comfir_mail","click",function(){var b="https://passport.zhe800.com/users/email_signed?email="+encodeURIComponent(a("#dialog_log_qiandao #ddusername").val());a(this);h&&(h=!1,a.getScript("https://passport.zhe800.com/api/ued/retries/send_active_email_confirmation?email="+encodeURIComponent(a("#dialog_log_qiandao #ddusername").val())+"&secret="+encodeURIComponent(window.login_error_result.secret||""),{callback:function(){window.location=b}}))})},k.drawPassportWait=function(a){},k._drawPassportCard=function(){i.dback()},k.drawPassportInfo=function(){},k.loginApp=function(){a("body").trigger("login")},k.logoutApp=function(){a("body").trigger("logout")},k.drawPassport(e),k.showMsg=function(a){this.loginMsg&&("邮箱未激活"==a&&(a+=',<span class="comfir_mail">去激活邮箱</span>'),this.loginMsg.html(a).show())}},sendCaptchado:function(b,c,d){var h=this;this.clickable=!0,b.click(function(){var i=this,j=Keeper("regDialog"),k=(a(i).parents("li"),d.parents("li"),a(this).parents('form[name="loginform"]')),l=k.find(".pperrmsg"),m=k.find("#phone_img_captcha_box");if(g("huoqudongtaima_tanchuang"),d.val()===d.attr("title")||""===d.val())return l.html("<em></em>请输入手机号").show(),!1;if(!/^1\d{10}/.test(d.val()))return l.html("<em></em>手机号格式有误").show(),!1;m.find('input[name="captcha_img"]');b.attr("disabled","disabled"),b.val(b.attr("data-text-submit")),h.clickable&&(h.clickable=!1,j.ajaxGetAuthToken(function(b){if(!b||!b.authenticity_token)return l.html("<em></em>请重新获取手机动态码").show(),e(h),!1;a("#reg_authenticity_token").val(b.authenticity_token);var g={mobile:d.val(),timestamp:(new Date).getTime(),type:c||"",token:b.authenticity_token};"yes"===m.attr("data-allow-captcha")&&(g.hasCaptcha=!0,g.captcha=m.find('input[name="captcha_img"]').val(),g.captcha_keywords=m.find('input[name="captcha_keywords"]').val(),m.find('input[name="captcha_img"]').val("")),j.ajaxSendCaptcha(g,function(a){switch(a.status){case 201:l.html("<em></em>验证码发送成功").show(),f(h);break;case 0:a.errors&&(a.errors.phone_number?l.html("<em></em>"+a.errors.phone_number).show():a.errors.phone_confirmation&&l.html("<em></em>"+a.errors.phone_confirmation[0]).show()),f(h);break;case 400:a.errors&&l.html('<em></em>手机号未注册，请<a class="pperrmsgcl" href="https://passport.zhe800.com/users/signup" target="_blank">注册折800账号</a>').show(),e(h);break;case 401:case 402:a.errors&&l.html("<em></em>"+a.errors).show(),e(h)}h.getCaptcha()})}))})},getCaptcha:function(){var b=this,c=Keeper("regDialog"),d=a("#phone_img_captcha_box");c.getCaptcha(function(c,e){if(c)d.attr("data-allow-captcha","yes"),d.find("img.captcha-img").attr("src",e.captcha_img),d.find('input[name="captcha_keywords"]').val(e.captcha_keywords),a(".captcha_box_new").show(),a(".captcha_img").hide();else{var f=a('form[name="loginform"] .pperrmsg');f.html("<em></em>请重新获取手机动态码").show()}d.find("img.captcha-img,.captRefash").off("click.captcha").on("click.captcha",function(a){b.getCaptcha()})})},callbackQueue:[],init:function(c){var e=this,f=new b.Buffers;f.push('<div class="qd_login">'),f.push('<div class="hc clear" id="ppLogin_qd"></div>'),f.push("</div>"),-1!==window.location.href.split("/").indexOf("cart")&&(e.customeDataCache.isCart=!0);var g={id:"dialog_log_qiandao",overlay:!0,auto:!1,openfun:function(){d.drawPassportNew("ppLogin_qd",e.ppTpl,{appid:c&&c.appid?c.appid:3002,t:e}),a.each(e.callbackQueue,function(b,c){if("function"==a.type(c))try{c.apply(this,[])}catch(d){window.console&&console.info(d.message)}}),e.getClickObj()},msg:f.toString()};return a.Dialogs(a.extend(g,c)),!1},dback:function(){a("#dialog_log_qiandao .close").trigger("click")},statisticCount:function(b){var c={"关闭操作":"deal_details_login_close","立即注册":"deal_details_register_immediately","立即登录":"deal_details_login_login_immediately","忘记密码":"deal_details_forget_secret_code","QQ登录":"deal_details_QQ_login",baidu:"deal_details_baidu_login",sina:"deal_details_weibo_login",taobao:"deal_details_taobao_login",renren:"deal_details_renren_login","注册后关闭":"deal_details_register_close","注册后立即登录":"deal_details_register_login_immediately","同意协议并注册":"deal_details_agree_to_register","邮箱注册":"deal_details_email_to_register"};1==this.customeDataCache.isCart&&a.each(c,function(a,b){c[a]=b.replace(/deal_details/,"cart")});var d=c[a.trim(b)];d===this.customeDataCache.cache||(this.customeDataCache.cache=d);var e=Keeper.cookie("__utma"),f="";f=e?""+e.split(".")[1]+e.split(".")[2]:"",this.imgload({clickkey:d,hiveid:f,date:(new Date).getTime()})},getClickObj:function(){var b=this;a(".diginfo").on("click",".statisticalObject",function(c){var d=a(this),e=a.trim(d.text()||d.val());e||(e=d.attr("class").split(" ")[0]),b.customeDataCache.isImmidately=!1,"立即登录"===e&&b.customeDataCache.flag===!0?(e="注册后立即登录",b.customeDataCache.isImmidately=!0,b.customeDataCache.flag=!1):"忘记密码？"===e&&(e="忘记密码"),b.statisticCount(e.replace(/>>/,""))})},imgload:function(b){var c=document.createElement("img"),d=[],e="http://analysis.tuanimg.com/panda/panda_v0.gif?";for(var f in b)b.hasOwnProperty(f)&&d.push(f+"="+b[f]);c.src=e+d.join("&"),c.onload=function(){a(this).remove()},document.body.appendChild(c)}})});